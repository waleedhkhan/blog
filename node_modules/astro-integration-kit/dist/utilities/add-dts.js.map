{"version":3,"sources":["../../src/utilities/add-dts.ts","../../src/core/define-utility.ts"],"sourcesContent":["import { mkdirSync, readFileSync, writeFileSync } from \"node:fs\";\nimport { dirname, relative } from \"node:path\";\nimport { fileURLToPath } from \"node:url\";\nimport type { AstroIntegrationLogger } from \"astro\";\nimport { parse, prettyPrint } from \"recast\";\nimport typescriptParser from \"recast/parsers/typescript.js\";\nimport { defineUtility } from \"../core/define-utility.js\";\n\nconst injectEnvDTS = ({\n\tsrcDir,\n\tlogger,\n\tspecifier,\n}: {\n\tsrcDir: URL;\n\tlogger: AstroIntegrationLogger;\n\tspecifier: URL | string;\n}) => {\n\tconst envDTsPath = fileURLToPath(new URL(\"env.d.ts\", srcDir));\n\n\tif (specifier instanceof URL) {\n\t\tspecifier = fileURLToPath(specifier);\n\t\tspecifier = relative(fileURLToPath(srcDir), specifier);\n\t\tspecifier = specifier.replaceAll(\"\\\\\", \"/\");\n\t}\n\n\tconst envDTsContents = readFileSync(envDTsPath, \"utf8\");\n\n\tif (envDTsContents.includes(`/// <reference types='${specifier}' />`)) {\n\t\treturn;\n\t}\n\tif (envDTsContents.includes(`/// <reference types=\"${specifier}\" />`)) {\n\t\treturn;\n\t}\n\n\tconst newEnvDTsContents = envDTsContents\n\t\t.replace(\n\t\t\t`/// <reference types='astro/client' />`,\n\t\t\t`/// <reference types='astro/client' />\\n/// <reference types='${specifier}' />`,\n\t\t)\n\t\t.replace(\n\t\t\t`/// <reference types=\"astro/client\" />`,\n\t\t\t`/// <reference types=\"astro/client\" />\\n/// <reference types=\"${specifier}\" />`,\n\t\t);\n\n\t// the odd case where the user changed the reference to astro/client\n\tif (newEnvDTsContents === envDTsContents) {\n\t\treturn;\n\t}\n\n\twriteFileSync(envDTsPath, newEnvDTsContents);\n\tlogger.info(\"Updated env.d.ts types\");\n};\n\n/**\n * Allows to inject .d.ts file in users project. It will create a file inside `.astro`\n * and reference it from `src/env.d.ts`.\n *\n * @param {import(\"astro\").HookParameters<\"astro:config:setup\">} params\n * @param {object} options\n * @param {string} options.name - The name of the .d.ts file. Eg `test` will generate `.astro/test.d.ts`\n * @param {string} options.content\n *\n * @example\n * ```ts\n * addDts(params, {\n * \t\tname: \"my-integration\",\n * \t \tcontent: `declare module \"virtual:my-integration\" {}`,\n * })\n * ```\n *\n * @see https://astro-integration-kit.netlify.app/utilities/add-dts/\n */\nexport const addDts = defineUtility(\"astro:config:setup\")(\n\t(\n\t\t{ config: { root, srcDir }, logger },\n\t\t{\n\t\t\tname,\n\t\t\tcontent,\n\t\t}: {\n\t\t\tname: string;\n\t\t\tcontent: string;\n\t\t},\n\t) => {\n\t\tconst dtsURL = new URL(`.astro/${name}.d.ts`, root);\n\t\tconst filePath = fileURLToPath(dtsURL);\n\n\t\tinjectEnvDTS({\n\t\t\tsrcDir,\n\t\t\tlogger,\n\t\t\tspecifier: dtsURL,\n\t\t});\n\n\t\tmkdirSync(dirname(filePath), { recursive: true });\n\t\twriteFileSync(\n\t\t\tfilePath,\n\t\t\tprettyPrint(\n\t\t\t\tparse(content, {\n\t\t\t\t\tparser: typescriptParser,\n\t\t\t\t}),\n\t\t\t\t{ tabWidth: 4 },\n\t\t\t).code,\n\t\t\t\"utf-8\",\n\t\t);\n\t},\n);\n","import type { HookParameters, Hooks } from \"./types.js\";\n\n/**\n * Allows defining a type-safe function requiring all the params of a given hook.\n * It uses currying to make TypeScript happy.\n *\n * @param {string} _hook\n *\n * @see https://astro-integration-kit.netlify.app/utilities/define-utility/\n *\n * @example\n * ```ts\n * const test = defineUtility(\"astro:config:setup\")((params, foo: boolean) => {\n *  return \"bar\";\n * });\n * ```\n */\nexport const defineUtility =\n\t<THook extends keyof Hooks>(_hook: THook) =>\n\t/**\n\t * The function itself\n\t * @param {Function} fn;\n\t */\n\t<TFn extends (params: HookParameters<THook>, ...args: Array<any>) => any>(\n\t\tfn: TFn,\n\t) =>\n\t\tfn;\n"],"mappings":"AAAA,OAAS,aAAAA,EAAW,gBAAAC,EAAc,iBAAAC,MAAqB,UACvD,OAAS,WAAAC,EAAS,YAAAC,MAAgB,YAClC,OAAS,iBAAAC,MAAqB,WAE9B,OAAS,SAAAC,EAAO,eAAAC,MAAmB,SACnC,OAAOC,MAAsB,+BCYtB,IAAMC,EACgBC,GAM3BC,GAEAA,EDlBF,IAAMC,EAAe,CAAC,CACrB,OAAAC,EACA,OAAAC,EACA,UAAAC,CACD,IAIM,CACL,IAAMC,EAAaC,EAAc,IAAI,IAAI,WAAYJ,CAAM,CAAC,EAExDE,aAAqB,MACxBA,EAAYE,EAAcF,CAAS,EACnCA,EAAYG,EAASD,EAAcJ,CAAM,EAAGE,CAAS,EACrDA,EAAYA,EAAU,WAAW,KAAM,GAAG,GAG3C,IAAMI,EAAiBC,EAAaJ,EAAY,MAAM,EAKtD,GAHIG,EAAe,SAAS,yBAAyBJ,CAAS,MAAM,GAGhEI,EAAe,SAAS,yBAAyBJ,CAAS,MAAM,EACnE,OAGD,IAAMM,EAAoBF,EACxB,QACA,yCACA;AAAA,wBAAiEJ,CAAS,MAC3E,EACC,QACA,yCACA;AAAA,wBAAiEA,CAAS,MAC3E,EAGGM,IAAsBF,IAI1BG,EAAcN,EAAYK,CAAiB,EAC3CP,EAAO,KAAK,wBAAwB,EACrC,EAqBaS,EAASC,EAAc,oBAAoB,EACvD,CACC,CAAE,OAAQ,CAAE,KAAAC,EAAM,OAAAZ,CAAO,EAAG,OAAAC,CAAO,EACnC,CACC,KAAAY,EACA,QAAAC,CACD,IAII,CACJ,IAAMC,EAAS,IAAI,IAAI,UAAUF,CAAI,QAASD,CAAI,EAC5CI,EAAWZ,EAAcW,CAAM,EAErChB,EAAa,CACZ,OAAAC,EACA,OAAAC,EACA,UAAWc,CACZ,CAAC,EAEDE,EAAUC,EAAQF,CAAQ,EAAG,CAAE,UAAW,EAAK,CAAC,EAChDP,EACCO,EACAG,EACCC,EAAMN,EAAS,CACd,OAAQO,CACT,CAAC,EACD,CAAE,SAAU,CAAE,CACf,EAAE,KACF,OACD,CACD,CACD","names":["mkdirSync","readFileSync","writeFileSync","dirname","relative","fileURLToPath","parse","prettyPrint","typescriptParser","defineUtility","_hook","fn","injectEnvDTS","srcDir","logger","specifier","envDTsPath","fileURLToPath","relative","envDTsContents","readFileSync","newEnvDTsContents","writeFileSync","addDts","defineUtility","root","name","content","dtsURL","filePath","mkdirSync","dirname","prettyPrint","parse","typescriptParser"]}